<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ–è€… ORï½œå› ä½ è€Œäº®</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root { --brand-color: #3a4a3a; --bg-color: #f9f7f2; }
    body { font-family: "PingFang TC","STHeitiTC-Light","Microsoft JhengHei",sans-serif; background-color: var(--bg-color); color: var(--brand-color); display:flex; justify-content:center; padding:20px; margin:0; -webkit-font-smoothing:antialiased; }
    .container { background:#fff; padding:50px 25px; border-radius:4px; box-shadow:0 10px 30px rgba(0,0,0,0.05); width:100%; max-width:400px; border-top:6px solid var(--brand-color); text-align:center; }
    .brand-logo { width:110px; margin:0 auto 15px auto; display:block; }
    .brand-slogan { font-size:16px; letter-spacing:0.3em; margin-bottom:30px; font-weight:500; color:var(--brand-color); }
    .status-text { font-size:13px; margin-bottom:20px; letter-spacing:0.1em; opacity:0.8; }

    .points-box { background:#f4f4f4; padding:35px 30px; margin:25px 0; border-radius:8px; }
    .points-label { font-size:12px; margin-bottom:8px; letter-spacing:0.2em; color:#888; }
    .points-num { font-size:60px; font-weight:bold; line-height:1; }

    .btn { background:var(--brand-color); color:#fff; border:none; padding:18px; width:100%; font-size:15px; letter-spacing:0.2em; cursor:pointer; transition:0.3s; margin-top:15px; font-weight:bold; }
    .btn:disabled { background:#ccc; cursor:not-allowed; }
    .btn-secondary { background:none; color:#999; font-weight:normal; text-decoration:underline; }

    #qrcode-canvas { background:#fff; padding:15px; display:inline-block; margin:20px 0; border:1px solid #eee; }
    .instruction { font-size:13px; color:#777; margin-bottom:25px; letter-spacing:0.05em; }
    .footer { margin-top:50px; font-size:12px; letter-spacing:0.15em; opacity:0.7; font-weight:400; }

    /* å…Œçæ¸…å–®æ¨£å¼ */
    .redeem-title { font-size:14px; letter-spacing:0.15em; margin:10px 0 18px 0; opacity:0.9; }
    .reward-card { background:#fff; border:1px solid #eee; border-radius:10px; padding:14px; text-align:left; margin:12px 0; }
    .reward-top { display:flex; justify-content:space-between; align-items:baseline; gap:10px; }
    .reward-points { font-weight:800; letter-spacing:0.05em; }
    .reward-badge { font-size:12px; color:#666; background:#eef2ee; padding:4px 8px; border-radius:999px; }
    .reward-desc { margin:10px 0 0 0; color:#444; font-size:13px; line-height:1.5; }
    .reward-note { margin:8px 0 0 0; color:#888; font-size:12px; line-height:1.4; }
    .reward-btn { margin-top:12px; padding:14px; font-size:14px; letter-spacing:0.12em; }
    .locked { opacity:0.55; }
  </style>
</head>
<body>

<div class="container">
  <img src="https://raw.githubusercontent.com/orlifehr/orlifehr-lineliff/main/logo.png" class="brand-logo">
  <div class="brand-slogan">è®“å¤¥ä¼´ç™¼å…‰</div>

  <div id="status" class="status-text">é€£ç·šä¸­...</div>

  <div id="main-content" style="display:none;">
    <div id="user-ui">
      <div class="points-box">
        <div class="points-label">ç´¯è¨ˆå‹³ç« æ•¸é‡</div>
        <div id="points-display" class="points-num">--</div>
      </div>

      <div id="qrcode-area">
        <div id="qrcode-canvas"></div>
        <p class="instruction">è«‹å‘HRå‡ºç¤ºæ­¤ç¢¼å–å¾—å‹³ç« </p>
      </div>

      <button id="redeemBtn" class="btn" style="background:#8b0000; display:none;">å‰å¾€å…Œæ›çå‹µ</button>

      <div id="redeem-ui" style="display:none;">
        <div class="redeem-title">å…Œæ›é¸é …</div>
        <div id="reward-list"></div>
        <button id="redeemBackBtn" class="btn btn-secondary" style="text-decoration:underline;">è¿”å›</button>
      </div>

      <button onclick="liff.closeWindow()" class="btn btn-secondary">é—œé–‰è¦–çª—</button>
    </div>

    <div id="staff-ui" style="display:none;">
      <div class="points-box" style="background:#eef2ee;">
        <p style="margin:0; font-size:13px; letter-spacing:0.1em;">æˆäºˆå‹³ç« æ¨¡å¼</p>
        <h2 id="target-user-name" style="margin:15px 0; letter-spacing:0.05em;">---</h2>
        <p style="font-size:13px; color:#666;">ç¢ºèªç‚ºè©²åŒä»å¢åŠ  1 æšå‹³ç« ï¼Ÿ</p>
      </div>
      <button id="staffAddBtn" class="btn">ç¢ºèªæˆäºˆ</button>
      <button onclick="liff.closeWindow()" class="btn btn-secondary" style="text-decoration:none;">å–æ¶ˆé€€å‡º</button>
    </div>
  </div>

  <div class="footer">è®“åœ¨åœ°äººé©•å‚² æ—…è¡Œè€…æ†§æ†¬ â€” æˆ–è€…</div>
</div>

<script>
  const LIFF_ID = "2008901106-Au1lEG1Q";
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzXuwYOyVmNes71__tI9JvhjTYVGfvWEbbm0Fg_zbc2W00ZVPPi9rFyEDGoGfn27374/exec";

  // å…Œçæ¸…å–®ï¼ˆå‰ç«¯é¡¯ç¤ºç”¨ï¼‰
  const REWARDS = [
    { points: 3,  title: "150å…ƒå…§é£²å“", note: "æ–¼åˆä½œåº—å®¶æˆ–æŒ‡å®šæ–¹å¼å…Œæ›" },
    { points: 6,  title: "500å…ƒå…§æ›¸æœ¬ä¸€æœ¬", note: "è‡ªé¸ä¸€æœ¬ï¼ˆä»¥å¯¦ä»˜é‡‘é¡ç‚ºæº–ï¼‰" },
    { points: 9,  title: "700å…ƒè‡ªæˆ‘æˆé•·ç›¸é—œèª²ç¨‹æˆ–è¬›åº§", note: "éœ€èˆ‡ HR ç¢ºèªèª²ç¨‹/è¬›åº§å…§å®¹" },
    { points: 18, title: "ä»»é¸1000å…ƒå…§å·¥è—å“", note: "ä»¥å¯¦ä»˜é‡‘é¡ç‚ºæº–" },
    { points: 30, title: "å¹³æ—¥é¢¨æ—…ä½å®¿ä¸€æ™š", note: "é™å¹³æ—¥ï¼Œéœ€æå‰èˆ‡ HR é ç´„ç¢ºèª" }
  ];

  let currentPoints = 0;
  let currentProfile = null;

  async function init() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }

      const profile = await liff.getProfile();
      currentProfile = profile;

      const params = new URLSearchParams(window.location.search);
      const act = params.get('act');

      document.getElementById('status').innerText = `ä½ å¥½ï¼Œ${profile.displayName}`;
      document.getElementById('main-content').style.display = 'block';

      if (act === 'staff_add') {
        document.getElementById('user-ui').style.display = 'none';
        document.getElementById('staff-ui').style.display = 'block';
        document.getElementById('target-user-name').innerText = params.get('name');

        document.getElementById('staffAddBtn').onclick = async () => {
          const btn = document.getElementById('staffAddBtn');
          btn.disabled = true;
          btn.innerText = "é©—è­‰æ¬Šé™ä¸­...";

          try {
            const response = await fetch(SCRIPT_URL, {
              method: 'POST',
              body: JSON.stringify({
                action: 'staff_add',
                userId: params.get('uid'),
                displayName: params.get('name'),
                staffId: profile.userId
              })
            });
            const result = await response.text();

            if (result === "SUCCESS") {
              alert("âœ¨ æˆäºˆå‹³ç« æˆåŠŸï¼");
              liff.closeWindow();
            } else if (result === "NO_PERMISSION") {
              alert("âŒ æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯æˆæ¬Šä¹‹HRã€‚");
              btn.disabled = false;
              btn.innerText = "ç¢ºèªæˆäºˆ";
            } else {
              alert("ç³»çµ±ç•°å¸¸ï¼Œè«‹è¯çµ¡HR");
              btn.disabled = false;
              btn.innerText = "ç¢ºèªæˆäºˆ";
            }
          } catch (err) {
            alert("é€šè¨Šå®Œæˆï¼Œè«‹æª¢æŸ¥å‹³ç« ç‹€æ³ã€‚");
            liff.closeWindow();
          }
        };

      } else {
        await loadPointsAndRender(profile);
      }

    } catch (e) {
      document.getElementById('status').innerText = "ç³»çµ±é€£ç·šå¤±æ•—";
    }
  }

  async function loadPointsAndRender(profile) {
    const res = await fetch(SCRIPT_URL + "?uid=" + profile.userId);
    const pts = parseInt(await res.text()) || 0;
    currentPoints = pts;
    document.getElementById('points-display').innerText = pts;

    // QR
    document.getElementById("qrcode-canvas").innerHTML = "";
    new QRCode(document.getElementById("qrcode-canvas"), {
      text: `https://liff.line.me/${LIFF_ID}?act=staff_add&uid=${profile.userId}&name=${encodeURIComponent(profile.displayName)}`,
      width: 180,
      height: 180,
      colorDark: "#3a4a3a"
    });

    // âœ… å…Œçï¼šæœ€ä½ 3 æšå³å¯é¡¯ç¤º
    const redeemBtn = document.getElementById('redeemBtn');
    if (pts >= 3) {
      redeemBtn.style.display = 'block';
      redeemBtn.onclick = () => showRedeemUI();
    } else {
      redeemBtn.style.display = 'none';
    }

    // è¿”å›
    document.getElementById('redeemBackBtn').onclick = () => hideRedeemUI();
  }

  function showRedeemUI() {
    document.getElementById('redeem-ui').style.display = 'block';
    document.getElementById('qrcode-area').style.display = 'none';
    document.getElementById('redeemBtn').style.display = 'none';
    renderRewardList();
  }

  function hideRedeemUI() {
    document.getElementById('redeem-ui').style.display = 'none';
    document.getElementById('qrcode-area').style.display = 'block';
    if (currentPoints >= 3) document.getElementById('redeemBtn').style.display = 'block';
  }

  function renderRewardList() {
    const list = document.getElementById('reward-list');
    list.innerHTML = "";

    REWARDS.forEach(r => {
      const canRedeem = currentPoints >= r.points;

      const card = document.createElement("div");
      card.className = "reward-card" + (canRedeem ? "" : " locked");

      card.innerHTML = `
        <div class="reward-top">
          <div class="reward-points">${r.points} æš</div>
          <div class="reward-badge">${canRedeem ? "å¯å…Œæ›" : "å‹³ç« ä¸è¶³"}</div>
        </div>
        <div class="reward-desc">ğŸ ${r.title}</div>
        <div class="reward-note">${r.note}</div>
      `;

      const btn = document.createElement("button");
      btn.className = "btn reward-btn";
      btn.style.background = canRedeem ? "#3a4a3a" : "#ccc";
      btn.disabled = !canRedeem;
      btn.innerText = "ç¢ºèªå…Œæ›";
      btn.onclick = () => redeemReward(r.points, r.title);

      card.appendChild(btn);
      list.appendChild(card);
    });
  }

  async function redeemReward(points, title) {
    if (!confirm(`ç¢ºå®šè¦ä½¿ç”¨ ${points} æšå‹³ç« å…Œæ›ã€Œ${title}ã€å—ï¼Ÿ`)) return;

    // é¿å…é€£é»
    Array.from(document.querySelectorAll(".reward-btn")).forEach(b => b.disabled = true);

    try {
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'redeem',
          userId: currentProfile.userId,
          displayName: currentProfile.displayName,
          redeemPoints: points
        })
      });
      const result = await response.text();

      if (result === "SUCCESS") {
        alert("ğŸ‰ å…Œæ›æˆåŠŸï¼è«‹ä¾è¦å‰‡å‘ HR é€²è¡Œé ˜å–/æ ¸éŠ·ã€‚");
        location.reload();
      } else if (result === "INSUFFICIENT_POINTS") {
        alert("å‹³ç« ä¸è¶³ï¼Œç„¡æ³•å…Œæ›ã€‚");
        location.reload();
      } else if (result === "INVALID_REWARD") {
        alert("å…Œæ›é …ç›®ç„¡æ•ˆï¼Œè«‹æ›´æ–°é é¢å¾Œå†è©¦ã€‚");
        location.reload();
      } else {
        alert("ç³»çµ±ç•°å¸¸ï¼Œè«‹è¯çµ¡HR");
        location.reload();
      }
    } catch (err) {
      alert("é€šè¨Šå®Œæˆï¼Œè«‹æª¢æŸ¥å…Œæ›ç´€éŒ„æˆ–è¯çµ¡ HRã€‚");
      location.reload();
    }
  }

  init();
</script>
</body>
</html>
