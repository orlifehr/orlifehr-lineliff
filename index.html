<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ–è€… ORï½œå› ä½ è€Œäº®</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root { --brand-color: #3a4a3a; --bg-color: #f9f7f2; }
    body { font-family: "PingFang TC","STHeitiTC-Light","Microsoft JhengHei",sans-serif; background-color: var(--bg-color); color: var(--brand-color); display:flex; justify-content:center; padding:20px; margin:0; -webkit-font-smoothing:antialiased; }
    .container { background:#fff; padding:50px 25px; border-radius:4px; box-shadow:0 10px 30px rgba(0,0,0,0.05); width:100%; max-width:400px; border-top:6px solid var(--brand-color); text-align:center; }
    .brand-logo { width:110px; margin:0 auto 15px auto; display:block; }
    .brand-slogan { font-size:16px; letter-spacing:0.3em; margin-bottom:30px; font-weight:500; color:var(--brand-color); }
    .status-text { font-size:13px; margin-bottom:20px; letter-spacing:0.1em; opacity:0.8; }

    .points-box { background:#f4f4f4; padding:35px 30px; margin:25px 0; border-radius:8px; }
    .points-label { font-size:12px; margin-bottom:8px; letter-spacing:0.2em; color:#888; }
    .points-num { font-size:60px; font-weight:bold; line-height:1; }

    .btn { background:var(--brand-color); color:#fff; border:none; padding:18px; width:100%; font-size:15px; letter-spacing:0.2em; cursor:pointer; transition:0.3s; margin-top:15px; font-weight:bold; }
    .btn:disabled { background:#ccc; cursor:not-allowed; }
    .btn-secondary { background:none; color:#999; font-weight:normal; text-decoration:underline; }

    #qrcode-canvas { background:#fff; padding:15px; display:inline-block; margin:20px 0; border:1px solid #eee; }
    .instruction { font-size:13px; color:#777; margin-bottom:25px; letter-spacing:0.05em; }
    .footer { margin-top:50px; font-size:12px; letter-spacing:0.15em; opacity:0.7; font-weight:400; }

    .redeem-title { font-size:14px; letter-spacing:0.15em; margin:10px 0 18px 0; opacity:0.9; }
    .reward-card { background:#fff; border:1px solid #eee; border-radius:10px; padding:14px; text-align:left; margin:12px 0; }
    .reward-top { display:flex; justify-content:space-between; align-items:baseline; gap:10px; }
    .reward-points { font-weight:800; letter-spacing:0.05em; }
    .reward-badge { font-size:12px; color:#666; background:#eef2ee; padding:4px 8px; border-radius:999px; }
    .reward-desc { margin:10px 0 0 0; color:#444; font-size:13px; line-height:1.5; }
    .reward-note { margin:8px 0 0 0; color:#888; font-size:12px; line-height:1.4; }
    .reward-btn { margin-top:12px; padding:14px; font-size:14px; letter-spacing:0.12em; }
    .locked { opacity:0.55; }

    .grant-row { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:14px; }
    .grant-label { font-size:13px; color:#666; letter-spacing:0.08em; }
    .grant-input {
      width:110px;
      padding:12px 10px;
      font-size:18px;
      font-weight:700;
      text-align:center;
      border:1px solid #ddd;
      border-radius:10px;
      outline:none;
      color: var(--brand-color);
      background:#fff;
    }
    .grant-hint { font-size:12px; color:#888; margin-top:10px; letter-spacing:0.05em; }
  </style>
</head>
<body>

<div class="container">
  <img src="https://raw.githubusercontent.com/orlifehr/orlifehr-lineliff/main/logo.png" class="brand-logo">
  <div class="brand-slogan">è®“å¤¥ä¼´ç™¼å…‰</div>

  <div id="status" class="status-text">é€£ç·šä¸­...</div>

  <div id="main-content" style="display:none;">
    <div id="user-ui">
      <div class="points-box">
        <div class="points-label">ç´¯è¨ˆå‹³ç« æ•¸é‡</div>
        <div id="points-display" class="points-num">--</div>
      </div>

      <div id="qrcode-area">
        <div id="qrcode-canvas"></div>
        <p class="instruction">è«‹å‘HRå‡ºç¤ºæ­¤ç¢¼å–å¾—å‹³ç« </p>
      </div>

      <button id="redeemBtn" class="btn" style="background:#8b0000; display:none;">å‰å¾€å…Œæ›çå‹µ</button>

      <div id="redeem-ui" style="display:none;">
        <div class="redeem-title">å…Œæ›é¸é …</div>
        <div id="reward-list"></div>
        <button id="redeemBackBtn" class="btn btn-secondary" style="text-decoration:underline;">è¿”å›</button>
      </div>

      <button onclick="liff.closeWindow()" class="btn btn-secondary">é—œé–‰è¦–çª—</button>
    </div>

    <div id="staff-ui" style="display:none;">
      <div class="points-box" style="background:#eef2ee;">
        <p style="margin:0; font-size:13px; letter-spacing:0.1em;">æˆäºˆå‹³ç« æ¨¡å¼</p>
        <h2 id="target-user-name" style="margin:15px 0; letter-spacing:0.05em;">---</h2>

        <div class="grant-row">
          <div class="grant-label">æˆäºˆæšæ•¸</div>
          <input id="grantCount" class="grant-input" type="number" min="1" max="30" step="1" value="1">
        </div>

        <div id="grantPreview" class="grant-hint">å°‡ç‚ºè©²åŒä»å¢åŠ  1 æšå‹³ç« </div>
        <div class="grant-hint">ï¼ˆä¸€æ¬¡æœ€å¤š 30 æšï¼›å¾Œç«¯ä¹Ÿæœƒæª¢æŸ¥ï¼‰</div>
      </div>

      <button id="staffAddBtn" class="btn">ç¢ºèªæˆäºˆ</button>
      <button onclick="liff.closeWindow()" class="btn btn-secondary" style="text-decoration:none;">å–æ¶ˆé€€å‡º</button>
    </div>
  </div>

  <div class="footer">è®“åœ¨åœ°äººé©•å‚² æ—…è¡Œè€…æ†§æ†¬ â€” æˆ–è€…</div>
</div>

<script>
  const LIFF_ID = "2008901106-Au1lEG1Q";
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzljDucaY1cVwYbPF2NFlOKsUvHMG1i5dRlOHNzc6Ugk2F0lVOE4_e9JjWU-MjrZv8U/exec";

  // âœ… å¾Œå‚™é è¨­ï¼šå¦‚æœå¾Œç«¯/å…Œçè¡¨å–ä¸åˆ°ï¼ŒUI ä»å¯é‹ä½œï¼ˆä¸å½±éŸ¿é¢¨æ ¼ï¼‰
  const DEFAULT_REWARDS = [
    { points: 3,  title: "150å…ƒå…§é£²å“", note: "æ–¼åˆä½œåº—å®¶æˆ–æŒ‡å®šæ–¹å¼å…Œæ›", enabled: true, sort: 1 },
    { points: 6,  title: "500å…ƒå…§æ›¸æœ¬ä¸€æœ¬", note: "è‡ªé¸ä¸€æœ¬ï¼ˆä»¥å¯¦ä»˜é‡‘é¡ç‚ºæº–ï¼‰", enabled: true, sort: 2 },
    { points: 9,  title: "700å…ƒè‡ªæˆ‘æˆé•·ç›¸é—œèª²ç¨‹æˆ–è¬›åº§", note: "éœ€èˆ‡ HR ç¢ºèªèª²ç¨‹/è¬›åº§å…§å®¹", enabled: true, sort: 3 },
    { points: 18, title: "ä»»é¸1000å…ƒå…§å·¥è—å“", note: "ä»¥å¯¦ä»˜é‡‘é¡ç‚ºæº–", enabled: true, sort: 4 },
    { points: 30, title: "å¹³æ—¥é¢¨æ—…ä½å®¿ä¸€æ™š", note: "é™å¹³æ—¥ï¼Œéœ€æå‰èˆ‡ HR é ç´„ç¢ºèª", enabled: true, sort: 5 }
  ];

  let REWARDS = DEFAULT_REWARDS.slice();

  let currentPoints = 0;
  let currentProfile = null;

  async function fetchRewards() {
    try {
      const res = await fetch(SCRIPT_URL + "?action=rewards&t=" + Date.now());
      const arr = await res.json();
      if (Array.isArray(arr) && arr.length > 0) {
        // æ­£è¦åŒ–æ¬„ä½ï¼ˆé¿å… sheet ä¸å°å¿ƒè¼¸å…¥æˆå­—ä¸²ï¼‰
        REWARDS = arr.map(r => ({
          points: parseInt(r.points, 10) || 0,
          title: String(r.title || ""),
          note: String(r.note || ""),
          enabled: true
        })).filter(r => r.points > 0 && r.title);
      } else {
        REWARDS = DEFAULT_REWARDS.slice();
      }
    } catch (e) {
      REWARDS = DEFAULT_REWARDS.slice();
    }
  }

  function getMinRewardPoints() {
    if (!REWARDS || REWARDS.length === 0) return Infinity;
    let min = Infinity;
    REWARDS.forEach(r => { if (r.points < min) min = r.points; });
    return min;
  }

  async function init() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }

      const profile = await liff.getProfile();
      currentProfile = profile;

      const params = new URLSearchParams(window.location.search);
      const act = params.get('act');

      document.getElementById('status').innerText = `ä½ å¥½ï¼Œ${profile.displayName}`;
      document.getElementById('main-content').style.display = 'block';

      if (act === 'staff_add') {
        document.getElementById('user-ui').style.display = 'none';
        document.getElementById('staff-ui').style.display = 'block';
        document.getElementById('target-user-name').innerText = params.get('name') || "ï¼ˆæœªå‘½åï¼‰";

        const input = document.getElementById('grantCount');
        const preview = document.getElementById('grantPreview');

        function clampCount(v) {
          let n = parseInt(v, 10);
          if (!Number.isFinite(n)) n = 1;
          if (n < 1) n = 1;
          if (n > 30) n = 30;
          return n;
        }

        function refreshPreview() {
          const n = clampCount(input.value);
          input.value = n;
          preview.innerText = `å°‡ç‚ºè©²åŒä»å¢åŠ  ${n} æšå‹³ç« `;
        }

        input.addEventListener('input', refreshPreview);
        refreshPreview();

        document.getElementById('staffAddBtn').onclick = async () => {
          const btn = document.getElementById('staffAddBtn');
          btn.disabled = true;
          btn.innerText = "é©—è­‰æ¬Šé™ä¸­...";

          const n = clampCount(input.value);

          try {
            // âœ… åˆªæ‰ headersï¼Œé¿å… CORS preflight æ“‹æ‰
            const response = await fetch(SCRIPT_URL, {
              method: 'POST',
              body: JSON.stringify({
                action: 'staff_add',
                userId: params.get('uid'),
                displayName: params.get('name'),
                staffId: profile.userId,
                grantCount: n
              })
            });

            const result = await response.text();

            if (result === "SUCCESS") {
              alert(`âœ¨ æˆäºˆå‹³ç« æˆåŠŸï¼ï¼ˆ+${n}ï¼‰`);
              liff.closeWindow();
            } else if (result === "NO_PERMISSION") {
              alert("âŒ æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯æˆæ¬Šä¹‹HRã€‚");
              btn.disabled = false;
              btn.innerText = "ç¢ºèªæˆäºˆ";
            } else if (result === "INVALID_GRANT_COUNT") {
              alert("âŒ æˆäºˆæšæ•¸ä¸åˆæ³•ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚");
              btn.disabled = false;
              btn.innerText = "ç¢ºèªæˆäºˆ";
            } else {
              alert("ç³»çµ±ç•°å¸¸ï¼Œè«‹è¯çµ¡HR");
              btn.disabled = false;
              btn.innerText = "ç¢ºèªæˆäºˆ";
            }
          } catch (err) {
            alert("é€šè¨Šå®Œæˆï¼Œè«‹æª¢æŸ¥å‹³ç« ç‹€æ³ã€‚");
            liff.closeWindow();
          }
        };

      } else {
        await loadPointsAndRender(profile);
      }

    } catch (e) {
      document.getElementById('status').innerText = "ç³»çµ±é€£ç·šå¤±æ•—";
    }
  }

  async function loadPointsAndRender(profile) {
    // å…ˆæŠ“å…Œçè¡¨ï¼ˆè®“ UI æ°¸é è·Ÿ Sheet åŒæ­¥ï¼‰
    await fetchRewards();

    // âœ… åŠ  timestamp é¿å…å¿«å–
    const res = await fetch(SCRIPT_URL + "?uid=" + profile.userId + "&t=" + Date.now());
    const pts = parseInt(await res.text()) || 0;
    currentPoints = pts;
    document.getElementById('points-display').innerText = pts;

    document.getElementById("qrcode-canvas").innerHTML = "";
    new QRCode(document.getElementById("qrcode-canvas"), {
      text: `https://liff.line.me/${LIFF_ID}?act=staff_add&uid=${profile.userId}&name=${encodeURIComponent(profile.displayName)}`,
      width: 180,
      height: 180,
      colorDark: "#3a4a3a"
    });

    const redeemBtn = document.getElementById('redeemBtn');
    const minPts = getMinRewardPoints();

    if (pts >= minPts) {
      redeemBtn.style.display = 'block';
      redeemBtn.onclick = () => showRedeemUI();
    } else {
      redeemBtn.style.display = 'none';
    }

    document.getElementById('redeemBackBtn').onclick = () => hideRedeemUI();
  }

  function showRedeemUI() {
    document.getElementById('redeem-ui').style.display = 'block';
    document.getElementById('qrcode-area').style.display = 'none';
    document.getElementById('redeemBtn').style.display = 'none';
    renderRewardList();
  }

  function hideRedeemUI() {
    document.getElementById('redeem-ui').style.display = 'none';
    document.getElementById('qrcode-area').style.display = 'block';
    if (currentPoints >= getMinRewardPoints()) document.getElementById('redeemBtn').style.display = 'block';
  }

  function renderRewardList() {
    const list = document.getElementById('reward-list');
    list.innerHTML = "";

    REWARDS.forEach(r => {
      const canRedeem = currentPoints >= r.points;

      const card = document.createElement("div");
      card.className = "reward-card" + (canRedeem ? "" : " locked");

      card.innerHTML = `
        <div class="reward-top">
          <div class="reward-points">${r.points} æš</div>
          <div class="reward-badge">${canRedeem ? "å¯å…Œæ›" : "å‹³ç« ä¸è¶³"}</div>
        </div>
        <div class="reward-desc">ğŸ ${r.title}</div>
        <div class="reward-note">${r.note || ""}</div>
      `;

      const btn = document.createElement("button");
      btn.className = "btn reward-btn";
      btn.style.background = canRedeem ? "#3a4a3a" : "#ccc";
      btn.disabled = !canRedeem;
      btn.innerText = "ç¢ºèªå…Œæ›";
      btn.onclick = () => redeemReward(r.points, r.title);

      card.appendChild(btn);
      list.appendChild(card);
    });
  }

  async function redeemReward(points, title) {
    if (!confirm(`ç¢ºå®šè¦ä½¿ç”¨ ${points} æšå‹³ç« å…Œæ›ã€Œ${title}ã€å—ï¼Ÿ`)) return;

    Array.from(document.querySelectorAll(".reward-btn")).forEach(b => b.disabled = true);

    try {
      // âœ… åˆªæ‰ headersï¼Œé¿å… CORS preflight æ“‹æ‰
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'redeem',
          userId: currentProfile.userId,
          displayName: currentProfile.displayName,
          redeemPoints: points
        })
      });

      const result = await response.text();

      if (result === "SUCCESS") {
        alert("ğŸ‰ å…Œæ›æˆåŠŸï¼è«‹ä¾è¦å‰‡å‘ HR é€²è¡Œé ˜å–/æ ¸éŠ·ã€‚");
        location.reload();
      } else if (result === "INSUFFICIENT_POINTS") {
        alert("å‹³ç« ä¸è¶³ï¼Œç„¡æ³•å…Œæ›ã€‚");
        location.reload();
      } else if (result === "INVALID_REWARD") {
        alert("å…Œæ›é …ç›®ç„¡æ•ˆï¼Œè«‹æ›´æ–°é é¢å¾Œå†è©¦ã€‚");
        location.reload();
      } else {
        alert("ç³»çµ±ç•°å¸¸ï¼Œè«‹è¯çµ¡HR");
        location.reload();
      }
    } catch (err) {
      alert("é€šè¨Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡ HRã€‚");
      location.reload();
    }
  }

  init();
</script>
</body>
</html>
