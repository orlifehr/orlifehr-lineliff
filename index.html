<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>或者 OR｜因你而亮</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root { --brand-color: #3a4a3a; --bg-color: #f9f7f2; }
    body { font-family: "PingFang TC","STHeitiTC-Light","Microsoft JhengHei",sans-serif; background-color: var(--bg-color); color: var(--brand-color); display:flex; justify-content:center; padding:20px; margin:0; -webkit-font-smoothing:antialiased; }
    .container { background:#fff; padding:50px 25px; border-radius:4px; box-shadow:0 10px 30px rgba(0,0,0,0.05); width:100%; max-width:400px; border-top:6px solid var(--brand-color); text-align:center; }

    .brand-logo { width:110px; margin:0 auto 15px auto; display:block; }
    .brand-slogan { font-size:16px; letter-spacing:0.3em; margin-bottom:30px; font-weight:500; color:var(--brand-color); }
    .status-text { font-size:13px; margin-bottom:20px; letter-spacing:0.1em; opacity:0.8; }

    .points-box { background:#f4f4f4; padding:35px 30px; margin:25px 0; border-radius:8px; }
    .points-label { font-size:12px; margin-bottom:8px; letter-spacing:0.2em; color:#888; }
    .points-num { font-size:60px; font-weight:bold; line-height:1; }

    .btn { background:var(--brand-color); color:#fff; border:none; padding:18px; width:100%; font-size:15px; letter-spacing:0.2em; cursor:pointer; transition:0.3s; margin-top:15px; font-weight:bold; }
    .btn:disabled { background:#ccc; cursor:not-allowed; }

    #qrcode-canvas { background:#fff; padding:15px; display:inline-block; margin:20px 0; border:1px solid #eee; }
    .instruction { font-size:13px; color:#777; margin-bottom:25px; letter-spacing:0.05em; }
    .footer { margin-top:50px; font-size:12px; letter-spacing:0.15em; opacity:0.7; font-weight:400; }

    /* ✅ HR 授予枚數輸入 */
    .grant-row { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:14px; }
    .grant-label { font-size:13px; color:#666; letter-spacing:0.08em; }
    .grant-input {
      width:110px;
      padding:12px 10px;
      font-size:18px;
      font-weight:700;
      text-align:center;
      border:1px solid #ddd;
      border-radius:10px;
      outline:none;
      color: var(--brand-color);
      background:#fff;
    }
    .grant-hint { font-size:12px; color:#888; margin-top:10px; letter-spacing:0.05em; }
  </style>
</head>
<body>

<div class="container">
  <img src="https://raw.githubusercontent.com/orlifehr/orlifehr-lineliff/main/logo.png" class="brand-logo">
  <div class="brand-slogan">讓夥伴發光</div>

  <div id="status" class="status-text">連線中...</div>

  <div id="main-content" style="display:none;">
    <div id="user-ui">
      <div class="points-box">
        <div class="points-label">累計勳章數量</div>
        <div id="points-display" class="points-num">--</div>
      </div>

      <div id="qrcode-canvas"></div>
      <p class="instruction">請向HR出示此碼取得勳章</p>

      <!-- 你原本的兌獎按鈕（若你已改成多選兌獎 UI，可忽略/替換） -->
      <button id="redeemBtn" class="btn" style="background:#8b0000; display:none;">前往兌換獎勵</button>

      <button onclick="liff.closeWindow()" class="btn" style="background:none; color:#999; font-weight:normal; text-decoration: underline;">關閉視窗</button>
    </div>

    <!-- ✅ HR 授予模式：新增授予枚數 -->
    <div id="staff-ui" style="display:none;">
      <div class="points-box" style="background:#eef2ee;">
        <p style="margin:0; font-size:13px; letter-spacing:0.1em;">授予勳章模式</p>
        <h2 id="target-user-name" style="margin: 15px 0; letter-spacing: 0.05em;">---</h2>

        <div class="grant-row">
          <div class="grant-label">授予枚數</div>
          <input id="grantCount" class="grant-input" type="number" min="1" max="30" step="1" value="1">
        </div>

        <div id="grantPreview" class="grant-hint">將為該同仁增加 1 枚勳章</div>
        <div class="grant-hint">（建議一次最多 30 枚，可自行調整上限）</div>
      </div>

      <button id="staffAddBtn" class="btn">確認授予</button>
      <button onclick="liff.closeWindow()" class="btn" style="background:none; color:#999; font-weight:normal;">取消退出</button>
    </div>
  </div>

  <div class="footer">讓在地人驕傲 旅行者憧憬 — 或者</div>
</div>

<script>
  const LIFF_ID = "2008901106-Au1lEG1Q";
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzXuwYOyVmNes71__tI9JvhjTYVGfvWEbbm0Fg_zbc2W00ZVPPi9rFyEDGoGfn27374/exec";

  async function init() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }

      const profile = await liff.getProfile();
      const params = new URLSearchParams(window.location.search);
      const act = params.get('act');

      document.getElementById('status').innerText = `你好，${profile.displayName}`;
      document.getElementById('main-content').style.display = 'block';

      if (act === 'staff_add') {
        document.getElementById('user-ui').style.display = 'none';
        document.getElementById('staff-ui').style.display = 'block';
        document.getElementById('target-user-name').innerText = params.get('name') || "（未命名）";

        const input = document.getElementById('grantCount');
        const preview = document.getElementById('grantPreview');

        function clampCount(v) {
          let n = parseInt(v, 10);
          if (!Number.isFinite(n)) n = 1;
          if (n < 1) n = 1;
          if (n > 30) n = 30; // ✅ 前端上限（後端也會再檢查）
          return n;
        }

        function refreshPreview() {
          const n = clampCount(input.value);
          input.value = n;
          preview.innerText = `將為該同仁增加 ${n} 枚勳章`;
        }

        input.addEventListener('input', refreshPreview);
        refreshPreview();

        document.getElementById('staffAddBtn').onclick = async () => {
          const btn = document.getElementById('staffAddBtn');
          btn.disabled = true;
          btn.innerText = "驗證權限中...";

          const n = clampCount(input.value);

          try {
            const response = await fetch(SCRIPT_URL, {
              method: 'POST',
              body: JSON.stringify({
                action: 'staff_add',
                userId: params.get('uid'),
                displayName: params.get('name'),
                staffId: profile.userId,
                grantCount: n // ✅ 新增：授予枚數
              })
            });
            const result = await response.text();

            if (result === "SUCCESS") {
              alert(`✨ 授予勳章成功！（+${n}）`);
              liff.closeWindow();
            } else if (result === "NO_PERMISSION") {
              alert("❌ 權限不足：您不是授權之HR。");
              btn.disabled = false;
              btn.innerText = "確認授予";
            } else if (result === "INVALID_GRANT_COUNT") {
              alert("❌ 授予枚數不合法，請重新輸入。");
              btn.disabled = false;
              btn.innerText = "確認授予";
            } else {
              alert("系統異常，請聯絡HR");
              btn.disabled = false;
              btn.innerText = "確認授予";
            }
          } catch (err) {
            alert("通訊完成，請檢查勳章狀況。");
            liff.closeWindow();
          }
        };

      } else {
        const res = await fetch(SCRIPT_URL + "?uid=" + profile.userId);
        const pts = parseInt(await res.text()) || 0;
        document.getElementById('points-display').innerText = pts;

        new QRCode(document.getElementById("qrcode-canvas"), {
          text: `https://liff.line.me/${LIFF_ID}?act=staff_add&uid=${profile.userId}&name=${encodeURIComponent(profile.displayName)}`,
          width: 180,
          height: 180,
          colorDark: "#3a4a3a"
        });

        // 你原本兌獎顯示條件（若你已改成多選兌獎 UI 請以你新版為主）
        if (pts >= 10) {
          document.getElementById('redeemBtn').style.display = 'block';
          document.getElementById('redeemBtn').onclick = () => {
            if(confirm("確定要扣除 10 枚兌換獎勵嗎？")) processRedeem(profile);
          };
        }
      }
    } catch (e) {
      document.getElementById('status').innerText = "系統連線失敗";
    }
  }

  async function processRedeem(profile) {
    await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'minus', userId: profile.userId, displayName: profile.displayName })
    });
    alert("兌換成功！");
    location.reload();
  }

  init();
</script>
</body>
</html>
