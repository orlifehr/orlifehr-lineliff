<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>或者 OR | 會員中心</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --brand-color: #3a4a3a; --bg-color: #f9f7f2; }
        body { font-family: "PingFang TC", sans-serif; background-color: var(--bg-color); color: var(--brand-color); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { background: white; padding: 40px 25px; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); width: 100%; max-width: 400px; border-top: 6px solid var(--brand-color); text-align: center; }
        .brand-logo { width: 120px; margin: 0 auto 20px auto; display: block; }
        .points-box { background: #f4f4f4; padding: 30px; margin: 20px 0; border-radius: 8px; }
        .points-num { font-size: 56px; font-weight: bold; line-height: 1; }
        .btn { background: var(--brand-color); color: white; border: none; padding: 16px; width: 100%; font-size: 16px; letter-spacing: 2px; cursor: pointer; transition: 0.3s; margin-top: 12px; font-weight: bold; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #qrcode-canvas { background: white; padding: 15px; display: inline-block; margin: 20px 0; border: 1px solid #eee; }
        .footer { margin-top: 40px; font-size: 11px; opacity: 0.5; }
    </style>
</head>
<body>

<div class="container">
    <img src="https://raw.githubusercontent.com/orlifehr/orlifehr-lineliff/main/logo.png" class="brand-logo">
    <div id="status" style="font-size: 14px; margin-bottom: 10px;">連線中...</div>

    <div id="main-content" style="display:none;">
        <div id="user-ui">
            <div class="points-box">
                <div id="points-display" class="points-num">--</div>
                <div style="font-size: 13px; margin-top: 10px; letter-spacing: 2px;">累計勳章數量</div>
            </div>
            <div id="qrcode-canvas"></div>
            <p style="font-size: 13px; color: #666; margin-bottom: 20px;">集點請向HR出示此碼</p>
            <button id="redeemBtn" class="btn" style="background:#8b0000; display:none;">前往兌換獎勵</button>
            <button onclick="liff.closeWindow()" class="btn" style="background:none; color:#999; font-weight:normal;">關閉視窗</button>
        </div>

        <div id="staff-ui" style="display:none;">
            <div class="points-box" style="background: #eef2ee;">
                <p style="margin:0; font-size: 14px;">授予勳章模式</p>
                <h2 id="target-user-name" style="margin: 15px 0;">---</h2>
                <p style="font-size: 13px; color: #666;">確認為該同仁增加 1 枚勳章？</p>
            </div>
            <button id="staffAddBtn" class="btn">確認授予</button>
            <button onclick="liff.closeWindow()" class="btn" style="background:none; color:#999;">取消退出</button>
        </div>
    </div>
    <div class="footer">讓夥伴發光 - 或者 OR</div>
</div>

<script>
    const LIFF_ID = "2008901106-Au1lEG1Q"; 
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzXuwYOyVmNes71__tI9JvhjTYVGfvWEbbm0Fg_zbc2W00ZVPPi9rFyEDGoGfn27374/exec";
    
    async function init() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            const params = new URLSearchParams(window.location.search);
            const act = params.get('act');
            
            document.getElementById('status').innerText = `你好，${profile.displayName}`;
            document.getElementById('main-content').style.display = 'block';

            if (act === 'staff_add') {
                // 店員模式
                document.getElementById('user-ui').style.display = 'none';
                document.getElementById('staff-ui').style.display = 'block';
                document.getElementById('target-user-name').innerText = params.get('name');

                document.getElementById('staffAddBtn').onclick = async () => {
                    const btn = document.getElementById('staffAddBtn');
                    btn.disabled = true;
                    btn.innerText = "驗證權限中...";

                    try {
                        // 使用 POST 發送並等待 GAS 回傳結果
                        const response = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'staff_add',
                                userId: params.get('uid'),
                                displayName: params.get('name'),
                                staffId: profile.userId
                            })
                        });
                        const result = await response.text();

                        if (result === "SUCCESS") {
                            alert("✨ 授予勳章成功！");
                            liff.closeWindow();
                        } else if (result === "NO_PERMISSION") {
                            alert("❌ 權限不足：您不是授權之HR。");
                            btn.disabled = false;
                            btn.innerText = "確認授予勳章";
                        } else {
                            alert("系統異常，請聯絡HR");
                        }
                    } catch (err) {
                        alert("通訊完成，請檢查勳章狀況。\n(若您非授權之HR，此操作將無效)");
                        liff.closeWindow();
                    }
                };

            } else {
                // 會員模式
                const res = await fetch(SCRIPT_URL + "?uid=" + profile.userId);
                const pts = parseInt(await res.text()) || 0;
                document.getElementById('points-display').innerText = pts;

                new QRCode(document.getElementById("qrcode-canvas"), {
                    text: `https://liff.line.me/${LIFF_ID}?act=staff_add&uid=${profile.userId}&name=${encodeURIComponent(profile.displayName)}`,
                    width: 180,
                    height: 180,
                    colorDark : "#3a4a3a"
                });

                if (pts >= 10) {
                    document.getElementById('redeemBtn').style.display = 'block';
                    document.getElementById('redeemBtn').onclick = () => {
                        if(confirm("確定要扣除 10 枚兌換獎勵嗎？")) processRedeem(profile);
                    };
                }
            }
        } catch (e) { document.getElementById('status').innerText = "系統連線失敗"; }
    }

    async function processRedeem(profile) {
        await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'minus', userId: profile.userId, displayName: profile.displayName })
        });
        alert("兌換成功！");
        location.reload();
    }
    init();
</script>
</body>
</html>
